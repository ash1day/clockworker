name: Trigger Collect Matches

on:
  schedule:
    # 6時間ごとに実行
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  trigger-if-idle:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger collect-matches if not running
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'collect-matches.yml',
              status: 'in_progress'
            })

            const queuedRuns = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'collect-matches.yml',
              status: 'queued'
            })

            const activeCount = runs.data.total_count + queuedRuns.data.total_count

            if (activeCount > 0) {
              console.log(`Already ${activeCount} run(s) active/queued, skipping`)
              return
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'collect-matches.yml',
              ref: 'main'
            })
            console.log('Triggered collect-matches')
